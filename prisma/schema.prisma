generator client {
  provider = "prisma-client"
  output   = "../generated/prisma"
}

datasource db {
  provider = "postgresql"
  // url      = env("DATABASE_URL")
}

model User {
  id                   Int               @id @default(autoincrement())
  firstName            String
  clerkUserId          String
  zynkEntityId         String?
  zynkFundingAccountId String?
  publicKey            String?
  lastName             String
  email                String            @unique
  phoneNumberPrefix    String
  phoneNumber          String
  nationality          String
  dateOfBirth          DateTime
  accountStatus        AccountStatus     @default(INITIAL)
  address              Address?
  wallet               Wallet?
  externalAccounts     ExternalAccount[]
  teleport             Teleport?
  created_at           DateTime          @default(now())
  updated_at           DateTime          @updatedAt

  @@map("users")
}

model Address {
  id           Int      @id @default(autoincrement())
  addressLine1 String
  addressLine2 String?
  locality     String
  city         String
  state        String
  country      String
  postalCode   String
  userId       Int      @unique
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  created_at   DateTime @default(now())
  updated_at   DateTime @updatedAt

  @@map("addresses")
}

model Wallet {
  id           Int           @id @default(autoincrement())
  userId       Int           @unique
  user         User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  zynkWalletId String        @unique
  walletName   String        @default("Primary Wallet")
  chain        String        @default("SOLANA")
  status       WalletStatus  @default(ACTIVE)
  account      WalletAccount?
  created_at   DateTime      @default(now())
  updated_at   DateTime      @updatedAt

  @@map("wallets")
}

model WalletAccount {
  id            Int      @id @default(autoincrement())
  walletId      Int      @unique
  wallet        Wallet   @relation(fields: [walletId], references: [id], onDelete: Cascade)
  address       String   @unique
  curve         String   @default("CURVE_ED25519")
  pathFormat    String   @default("PATH_FORMAT_BIP32")
  path          String
  addressFormat String   @default("ADDRESS_FORMAT_SOLANA")
  created_at    DateTime @default(now())
  updated_at    DateTime @updatedAt

  @@map("wallet_accounts")
}

model ExternalAccount {
  id                    Int                   @id @default(autoincrement())
  userId                Int
  user                  User                  @relation(fields: [userId], references: [id], onDelete: Cascade)
  zynkExternalAccountId String?               @unique
  walletAddress         String
  label                 String?
  type                  String                @default("withdrawal")
  walletId              String?
  status                ExternalAccountStatus @default(ACTIVE)
  teleports             Teleport[]
  created_at            DateTime              @default(now())
  updated_at            DateTime              @updatedAt
  deleted_at            DateTime?

  @@unique([userId, walletAddress])
  @@index([userId, status])
  @@map("external_accounts")
}

model Teleport {
  id                Int              @id @default(autoincrement())
  userId            Int              @unique
  user              User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  externalAccountId Int
  externalAccount   ExternalAccount  @relation(fields: [externalAccountId], references: [id], onDelete: Cascade)
  zynkTeleportId    String?          @unique
  status            TeleportStatus   @default(ACTIVE)
  created_at        DateTime         @default(now())
  updated_at        DateTime         @updatedAt

  @@map("teleports")
}

enum ExternalAccountStatus {
  ACTIVE
  INACTIVE
}

enum TeleportStatus {
  ACTIVE
  INACTIVE
}

enum WalletStatus {
  ACTIVE
  INACTIVE
}

enum AccountStatus {
  INITIAL
  ACTIVE
  PENDING
  REJECTED
}
